<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø¶ÙŠØ± Ø¨Ø±Ø§Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡Ø§Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¹Ø¯Ù†Ø§Ù† Ø§Ù„Ø§ÙƒØ­Ù„ÙŠ</title>
    <style>
        /* Basic Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f9fc;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, #4A90E2, #3A7BC8);
            color: white;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 25px;
            gap: 25px;
        }

        .sidebar {
            width: 320px;
            min-width: 300px;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar h2 {
            font-size: 1.6em;
            color: #3A7BC8;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 15px;
        }

        .sidebar label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #444;
        }

        .sidebar input[type="text"],
        .sidebar input[type="number"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 18px;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .sidebar input[type="text"]:focus,
        .sidebar input[type="number"]:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
            outline: none;
        }

        .api-key-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 20px;
            padding: 12px;
            background-color: #f7f9fc;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 95%;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 20px;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background-color: #dcf8c6;
            color: #333;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            border-color: #333;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .ai-message-content h1,
        .ai-message-content h2,
        .ai-message-content h3,
        .ai-message-content h4,
        .ai-message-content h5,
        .ai-message-content h6 {
            color: #3A7BC8;
            margin-top: 18px;
            margin-bottom: 10px;
        }
        .ai-message-content h1 { font-size: 1.6em; }
        .ai-message-content h2 { font-size: 1.4em; }
        .ai-message-content h3 { font-size: 1.2em; }
        .ai-message-content p {
            margin-bottom: 12px;
        }
        .ai-message-content ul,
        .ai-message-content ol {
            margin-left: 30px;
            margin-bottom: 12px;
        }
        .ai-message-content li {
            margin-bottom: 6px;
        }
        .ai-message-content strong {
            font-weight: 700;
        }
        .ai-message-content em {
            font-style: italic;
        }
        .ai-message-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
            font-size: 0.95em;
        }
        .ai-message-content th,
        .ai-message-content td {
            border: 1px solid #dcdcdc;
            padding: 10px;
            text-align: right;
        }
        .ai-message-content th {
            background-color: #f2f6fc;
            font-weight: bold;
            color: #4A90E2;
        }
        .ai-message-content td > p {
            margin-bottom: 0;
        }

        .ai-message .loading-dots span {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 3px;
            background-color: #888;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .ai-message .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-message .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .chat-input-area {
            display: flex;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }

        .chat-input-area button {
            background: linear-gradient(135deg, #4A90E2, #3A7BC8);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-input-area button:disabled {
            background: #a0c7ef;
            cursor: not-allowed;
            box-shadow: none;
        }
        .chat-input-area button:hover:not(:disabled) {
            background: linear-gradient(135deg, #3A7BC8, #4A90E2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .initial-placeholder {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b0b0b0;
            font-size: 1.3em;
            text-align: center;
            padding: 25px;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                margin-bottom: 25px;
                max-height: 45vh;
            }
            .chat-area {
                height: 55vh;
            }
        }

        @media (max-width: 576px) {
            header h1 {
                font-size: 1.5em;
            }
            .container {
                padding: 15px;
                gap: 15px;
            }
            .sidebar, .chat-area {
                padding: 20px;
            }
            .chat-messages {
                padding: 20px;
            }
            .chat-input-area {
                padding: 15px;
            }
            .chat-input-area button {
                min-height: 45px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body dir="rtl">

    <header>
        <h1>ØªØ­Ø¶ÙŠØ± Ø¨Ø±Ø§Ø¹Ø© Ù„Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø´Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¹Ø¯Ù†Ø§Ù† Ø§Ù„Ø§ÙƒØ­Ù„ÙŠ</h1>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø³</h2>
            <form id="lessonDetailsForm">
                <div>
                    <label for="classGrade">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                    <input type="text" id="classGrade" name="classGrade" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" required>
                </div>
                <div>
                    <label for="subject">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                    <input type="text" id="subject" name="subject" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" required>
                </div>
                <div>
                    <label for="lessonName">Ø¹Ù†ÙˆØ§Ù†/Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø³:</label>
                    <input type="text" id="lessonName" name="lessonName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù¡ØŒ Ù¢ØŒ Ù£" required>
                </div>
            </form>
            <div>
                <form id="chatForm" class="chat-input-area">
                    <button type="submit" id="sendButton">Ø¥Ø±Ø³Ø§Ù„</button>
                </form>
            </div>
        </aside>

        <main class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="initial-placeholder">
                    Ø§Ù…Ù„Ø£ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø³.
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION: REPLACE WITH YOUR ACTUAL GEMINI API KEY ---
        // IMPORTANT! Replace the placeholder string below with your actual Gemini API Key.
        // For example, if your key is "ABC123XYZ", the line should look like:
        // const API_KEY = "ABC123XYZ";
       
       
        const API_KEYS = [
            "AIzaSyBZM_2hvHgPPJUybUmOlKfQPvdUSyUfRTc",
            "AIzaSyD1svR63zy441xYElv_YSb386BdrGjFJA8"
        ];

        
        // --- END CONFIGURATION ---

        const AI_INSTRUCTIONS = `
        You are an expert curriculum designer AI specializing in creating detailed lesson plans for teachers, particularly in Arabic.
        Your task is to generate a comprehensive and practical lesson plan based on the user's request (class grade, subject, lesson topic, and specific requirements).

        **Output Format:**
*   Provide ONLY the lesson plan content, formatted in Arabic.
*   Do NOT include any conversational introductory or concluding phrases like "Here is your lesson plan:", "Certainly!", or "I hope this helps!".
*   Format your response using Markdown-like syntax. Use headings (#, ##, ###), bullet points (* or -), bold (**text**), and italics (*text*). Tables should be formatted using Markdown table syntax (as shown in the example).

        **Lesson Plan Structure (BarÄâ€˜ah Model - Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø±Ø§Ø¹Ø©):**
        The lesson plan should generally include the following sections, adapted as needed for the specific request. Pay close attention to the structure in the example:
        1.  **Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:** (Derived from user input)
        2.  **Ø§Ù„ØµÙ:** (Derived from user input)
        3.  **Ø§Ù„Ù…Ø§Ø¯Ø©:** (Derived from user input)
        4.  **Ø§Ù„Ø²Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­:** (If specified by user, otherwise suggest a common duration like 45-60 minutes and break it down per activity)
        5.  **Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©/Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©:** (What students will know or be able to do. Use action verbs, e.g., "Ø£Ù† ÙŠÙÙ…ÙŠØ² Ø§Ù„Ø·Ø§Ù„Ø¨...", "Ø£Ù† ÙŠÙØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨...")
        6.  **Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©:** (List all necessary items, including technology, handouts, fixed resources like whiteboards, and variable resources like videos or specific objects.)
        7.  **Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³ÙŠØ± Ø§Ù„Ø¯Ø±Ø³ (Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ù…Ù† Ù„ÙƒÙ„ Ù†Ø´Ø§Ø·):**
            *   **Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ (Warm-up/Engagement):** How to start the lesson and capture student interest. Include introductory questions.
            *   **Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ø¶ÙŠØ±ÙŠ (Preparatory Table / Main Activities Table):** This is a key part. Present this as a Markdown table.
            *   **Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Wrap-up/Closure):** Summary, check for understanding, review activities, and possibly preview next lesson.
        8.  **Ø§Ù„ØªÙ‚ÙˆÙŠÙ…:** (How learning will be checked - formative and/or summative activities or questions).
        9.  **Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„ÙØ±Ø¯ÙŠØ© (Differentiation):** (Strategies for diverse learners, if applicable).
        10. **Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ ÙˆØ£Ù†Ø´Ø·Ø© Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©/Ø¯Ø§Ø¹Ù…Ø© (Worksheets and Supporting/Enrichment Activities - Optional but good):** Suggest relevant worksheets or activities, possibly in a table format.
        11. **Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ Ø§Ù„ØµØ¹ÙˆØ¨Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Notes or Anticipated Difficulties - Optional):** Any additional important notes for the teacher.

        **VERY IMPORTANT EXAMPLE TO FOLLOW FOR STRUCTURE, DETAIL, AND STYLE (Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø±Ø§Ø¹Ø© Ù„Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø´Ø·):**

        Below is an exemplary lesson plan for a lesson on "Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù" (The letter Alif). Use this as a strong guide for how to structure the output, the level of detail expected in each section, and the Markdown formatting. The user will provide a different topic, grade, and subject. You need to adapt this example's structure to their new request.

        --- EXAMPLE LESSON PLAN ---

        ### ğŸŸ¢ ØªØ­Ø¶ÙŠØ± Ø¯Ø±Ø³: Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù

        **Ø§Ù„Ù…Ø§Ø¯Ø©:** Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        **Ø§Ù„ØµÙ:** Ø§Ù„Ø£ÙˆÙ„
        **Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­Ø¶ÙŠØ±:** Ø¨Ø±Ø§Ø¹Ø© Ù„Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø´Ø·

        ### 1. Ø§Ù„ØªÙ…Ù‡ÙŠØ¯

        **Ø³Ø¤Ø§Ù„ ØªØ­ÙÙŠØ²ÙŠ:**
        "Ù…Ù† ÙŠØ¹Ø±Ù ÙƒÙ„Ù…Ø© ØªØ¨Ø¯Ø£ Ø¨ØµÙˆØª (Ø£)ØŸ Ù‡Ù„ Ø³Ù…Ø¹ØªÙ… ØµÙˆØª (Ø£) ÙÙŠ ÙƒÙ„Ù…Ø© Ø£Ø³Ø¯ØŸ"

        **ÙˆØ³Ø§Ø¦Ù„:**
        Ø¹Ø±Ø¶ ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ù„Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù (Ø£) ÙˆØµÙˆØ±Ø© Ø£Ø³Ø¯ Ø£Ùˆ Ø£Ø±Ù†Ø¨.

        **ØªÙØ§Ø¹Ù„:**
        ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù„Ù‰ Ø°ÙƒØ± ÙƒÙ„Ù…Ø§Øª ÙŠØ¹Ø±ÙÙˆÙ†Ù‡Ø§ ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù.

        **ØªÙˆØ¶ÙŠØ­:**
        ØªÙ…ÙŠÙŠØ² Ø´ÙƒÙ„ Ø§Ù„Ø­Ø±Ù ÙˆØµÙˆØªÙ‡ØŒ ÙˆØ§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† "Ø£" Ùˆ"Ø§"ØŒ ÙˆØ§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø£Ù‡Ù…ÙŠØ© ØªØ¹Ù„Ù… Ø§Ù„Ø­Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©.


        ### 2. Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ­Ø¶ÙŠØ±

        | **Ø¯ÙˆØ± Ø§Ù„Ù…ØªØ¹Ù„Ù…** | **Ø¯ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù…** | **Ø§Ù„Ø²Ù…Ù†** | **Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„Ù…** | **ØµÙŠØ§ØºØ© Ø§Ù„Ù‡Ø¯Ù (ÙØ¹Ù„ Ù…Ø¶Ø§Ø±Ø¹)** | **Ø§Ù„Ù…Ø³ØªÙˆÙ‰** | **Ø§Ù„Ù…Ø¬Ø§Ù„** | **Ø§Ù„Ù…Ø­ØªÙˆÙ‰** |
        |---|---|---|---|---|---|---|---|
        | ÙŠØ³ØªÙ…Ø¹ ÙˆÙŠØ´Ø§Ø±Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© â€“ ÙŠØ°ÙƒØ± ÙƒÙ„Ù…Ø§Øª ÙÙŠÙ‡Ø§ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§Ù„Ø¹ØµÙ Ø§Ù„Ø°Ù‡Ù†ÙŠ ğŸ”¹ Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„ ğŸ”¹ ØªØ¯ÙˆÙŠÙ† ÙƒÙ„Ù…Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ù€(Ø£) ğŸ”¹ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµØ­ÙŠØ­Ø© ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: Ø³ÙÙ…Ù‘Ù Ø«Ù„Ø§Ø« ÙƒÙ„Ù…Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | 7 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø§Ù„Ø³Ø¨ÙˆØ±Ø©ØŒ ÙƒØªØ§Ø¨ Ø§Ù„Ø­Ø±ÙˆÙØŒ Ø§Ù„Ø£Ù‚Ù„Ø§Ù… ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: ØµÙˆØ± (Ø£Ø³Ø¯ØŒ Ø£Ø±Ù†Ø¨ØŒ Ø£Ù†Ø§Ù†Ø§Ø³) | ÙŠØ³Ù…Ù‘ÙŠ Ø«Ù„Ø§Ø« ÙƒÙ„Ù…Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | ØªØ°ÙƒØ± | Ù…Ø¹Ø±ÙÙŠ | Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ù…Ø¹ÙŠ Ù„Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù |
        | ÙŠÙ„Ø§Ø­Ø¸ Ø´ÙƒÙ„ Ø§Ù„Ø­Ø±Ù â€“ ÙŠØ±Ø³Ù…Ù‡ ÙÙŠ Ø§Ù„Ù‡ÙˆØ§Ø¡ â€“ ÙŠÙƒØªØ¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨Ø¥ØµØ¨Ø¹Ù‡ | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø¡ ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© ğŸ”¹ ØªØªØ¨Ø¹ Ø§Ù„Ø´ÙƒÙ„ Ø¨Ø§Ù„Ø£ØµØ¨Ø¹ ğŸ”¹ Ù…Ù†Ø§Ù‚Ø´Ø© Ù…ÙˆÙ‚Ø¹Ù‡ ÙÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: ÙƒÙŠÙ Ù†Ø±Ø³Ù… Ø­Ø±Ù Ø§Ù„Ø£Ù„ÙØŸ | 10 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø§Ù„Ø³Ø¨ÙˆØ±Ø©ØŒ Ù‚Ù„Ù… Ø§Ù„Ø³Ø¨ÙˆØ±Ø© ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­Ø±ÙˆÙØŒ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ± | ÙŠØ±Ø³Ù… Ø´ÙƒÙ„ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | ÙÙ‡Ù… | Ù…Ø¹Ø±ÙÙŠ | Ø´ÙƒÙ„ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù |
        | ÙŠÙÙƒØ± Ø¨ÙƒÙ„Ù…Ø§Øª â€“ ÙŠØªØ¹Ø§ÙˆÙ† Ù…Ø¹ Ø²Ù…ÙŠÙ„ â€“ ÙŠÙƒÙˆÙ‘Ù† Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: ÙÙƒØ± â€“ Ø²Ø§ÙˆØ¬ â€“ Ø´Ø§Ø±Ùƒ ğŸ”¹ ØªÙÙƒÙŠØ± ÙØ±Ø¯ÙŠ ğŸ”¹ ØªØ¨Ø§Ø¯Ù„ Ù…Ø¹ Ø²Ù…ÙŠÙ„ ğŸ”¹ Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: ÙƒÙˆÙ‘Ù† Ø¬Ù…Ù„Ø© ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | 6 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø§Ù„Ø³Ø¨ÙˆØ±Ø© ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: Ø¨Ø·Ø§Ù‚Ø§Øª ÙƒÙ„Ù…Ø§Øª | ÙŠÙƒÙˆÙ‘Ù† Ø¬Ù…Ù„Ø© Ù…Ù† Ø«Ù„Ø§Ø« ÙƒÙ„Ù…Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | ØªØ·Ø¨ÙŠÙ‚ | Ù…Ø¹Ø±ÙÙŠ | Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø±Ù ÙÙŠ Ø¬Ù…Ù„Ø© |
        | ÙŠØ¹Ù…Ù„ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© â€“ ÙŠÙ„ÙˆÙ† Ø§Ù„Ø­Ø±Ù â€“ ÙŠØ²ÙŠÙ†Ù‡ â€“ ÙŠÙ„ØµÙ‚ ØµÙˆØ± ÙƒÙ„Ù…Ø§Øª Ø¹Ù„ÙŠÙ‡ | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø®Ù„ÙŠØ© Ø§Ù„Ù†Ø­Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ÙŠØ© ğŸ”¹ ØªÙˆØ²ÙŠØ¹ Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ ğŸ”¹ Ù†Ø´Ø§Ø· ØªØ²ÙŠÙŠÙ† Ø§Ù„Ø­Ø±Ù ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: Ù…Ø§Ø°Ø§ ÙˆØ¶Ø¹Øª Ø¯Ø§Ø®Ù„ Ø­Ø±Ù Ø§Ù„Ø£Ù„ÙØŸ | 8 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: Ø£Ù„ÙˆØ§Ù†ØŒ Ù…Ø¬Ù„Ø§ØªØŒ Ù…Ù‚ØµØŒ ØºØ±Ø§Ø¡ | ÙŠØ²ÙŠÙ‘Ù† Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù Ø¨ØµÙˆØ± Ù…Ù† Ø¨ÙŠØ¦ØªÙ‡ | Ù…Ù…Ø§Ø±Ø³Ø© | Ù…Ù‡Ø§Ø±ÙŠ | Ù†Ø´Ø§Ø· ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ø±Ù |
        | ÙŠÙ„ÙˆÙ‘Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â€“ ÙŠØ±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙƒÙ„Ù…Ø© â€“ ÙŠØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ÙÙŠ ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°Ù‡Ù†ÙŠØ© ğŸ”¹ Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© ÙƒÙ„Ù…Ø§Øª ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù ğŸ”¹ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ø±Ù ÙÙŠ ÙƒÙ„ ÙƒÙ„Ù…Ø© ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: Ù„ÙˆÙ‘Ù† Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù ÙÙŠ ÙƒÙ„ ÙƒÙ„Ù…Ø© | 5 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø£ÙˆØ±Ø§Ù‚ ØªÙ„ÙˆÙŠÙ† ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: Ø®Ø±ÙŠØ·Ø© ÙƒÙ„Ù…Ø§ØªØŒ ØµÙˆØ± | ÙŠØ­Ø¯Ù‘Ø¯ Ù…ÙˆØ¶Ø¹ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù ÙÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© | Ø¥ØªÙ‚Ø§Ù† | Ù…Ù‡Ø§Ø±ÙŠ | Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨ØµØ±ÙŠ Ù„Ù„Ø­Ø±Ù |
        | ÙŠØ¹Ù…Ù„ Ø¶Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© â€“ ÙŠØ¬Ù‡Ø² Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© â€“ ÙŠØ´Ø±Ø­ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡ | Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…Ø±Ù‚Ù…Ø© ğŸ”¹ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ ğŸ”¹ Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„ ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© ğŸ”¹ Ø³Ø¤Ø§Ù„ ØªÙ‚ÙˆÙŠÙ…ÙŠ: Ø£ÙŠÙ† Ø³Ù…Ø¹Øª Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©ØŸ | 6 Ø¯Ù‚Ø§Ø¦Ù‚ | ğŸ”¹ Ø«Ø§Ø¨ØªØ©: Ø§Ù„Ø³Ø¨ÙˆØ±Ø© ğŸ”¹ Ù…ØªØºÙŠØ±Ø©: ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠØŒ ØµÙˆØ± | ÙŠØ³ØªÙ…Ø¹ ÙˆÙŠØ­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù | ØªØ­Ù„ÙŠÙ„ | Ù…Ø¹Ø±ÙÙŠ | Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ù…Ø¹ÙŠ ÙˆØ§Ù„Ø¨ØµØ±ÙŠ |


        ### 3. Ø§Ù„Ø¥ØºÙ„Ø§Ù‚

        **Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´ÙÙ‡ÙŠØ©:** Ø´ÙƒÙ„ Ø§Ù„Ø­Ø±ÙØŒ ØµÙˆØªÙ‡ØŒ ÙƒÙ„Ù…Ø§Øª ØªØ­ØªÙˆÙŠÙ‡.

        **Ø³Ø¤Ø§Ù„ Ø®ØªØ§Ù…ÙŠ:** "Ø§Ø°ÙƒØ± Ù„ÙŠ ÙƒÙ„Ù…Ø© ÙÙŠÙ‡Ø§ (Ø£) Ø³Ù…Ø¹ØªÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ…!"

        Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ± ÙÙŠÙ‡ Ø£ØºÙ†ÙŠØ© Ø¹Ù† Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù.

        ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù†Ø´Ø§Ø· Ù…Ù†Ø²Ù„ÙŠ Ø¨Ø³ÙŠØ·.

        ### 4. Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø«Ø±Ø§Ø¦ÙŠØ©

        ğŸ”¹ **Ù†Ø´Ø§Ø· Ø§Ø³ØªÙƒØ´Ø§ÙÙŠ:**
        Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø´ÙŠØ§Ø¡ ÙÙŠ Ø§Ù„Ø¨ÙŠØª ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù ÙˆØªØµÙˆÙŠØ±Ù‡Ø§.

        ğŸ”¹ **Ù„Ø¹Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ©:**
        Ù„Ø¹Ø¨Ø© "Ø£Ù†Ø§ Ø£Ù‚ÙˆÙ„ ÙˆØ£Ù†Øª ØªØ´ÙŠØ±": ÙŠÙÙ‚Ø§Ù„ "Ø£Ø±Ù†Ø¨" ÙˆØ§Ù„Ø·ÙÙ„ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø±Ù (Ø£).

        ğŸ”¹ **Ù…Ø´Ø±ÙˆØ¹ Ù…Ù†Ø²Ù„ÙŠ:**
        Ø¥Ù†Ø´Ø§Ø¡ "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø±Ù" Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¬Ù„Ø§Øª ÙˆÙ‚Øµ ØµÙˆØ± ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù.

        ğŸ”¹ **Ù†Ø´Ø§Ø· ÙÙ†ÙŠ:**
        ØµÙ†Ø¹ Ù…Ø¬Ø³Ù… Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ±Ù‚ Ù…Ù„ÙˆÙ† Ø£Ùˆ ØµÙ„ØµØ§Ù„.

        ### 5. Ø§Ù„ØµØ¹ÙˆØ¨Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©

        Ø§Ù„Ø®Ù„Ø· Ø¨ÙŠÙ† (Ø£ØŒ Ø§) Ø£Ùˆ Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±Ù Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦.

        ØµØ¹ÙˆØ¨Ø© ÙÙŠ Ø±Ø³Ù… Ø§Ù„Ø­Ø±Ù Ø¨Ø®Ø· Ø§Ù„ÙŠØ¯.

        ØªØ´ØªØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ø¨Ø³Ø¨Ø¨ Ø¶Ø¹Ù Ø§Ù„ØªØ±ÙƒÙŠØ².

        Ù‚Ù„Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª Ù„Ø¯Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨.

        --- END OF EXAMPLE LESSON PLAN ---

        Now, based on the user's specific inputs for grade, subject, topic, and their detailed request, generate a new lesson plan in Arabic, following this structure and style.
The user might provide input like:
Ø§Ù„ØµÙ "Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"
Ø§Ù„Ù…Ø§Ø¯Ø© "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ "ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù¡ØŒ Ù¢ØŒ Ù£ØŒ Ø´ÙƒÙ„Ù‡Ø§ØŒ ÙˆÙƒÙŠÙÙŠØ© ÙƒØªØ§Ø¨ØªÙ‡Ø§ØŒ ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø£Ø´ÙŠØ§Ø¡ Ù…Ø­Ø³ÙˆØ³Ø©"
ØªØ­Ø¶ÙŠØ± Ø¯Ø±Ø³ "Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ù¡ØŒ Ù¢ØŒ Ù£"

Your generated lesson plan should take these inputs and the user's free-form request to create a new plan.
        `;
        const chatForm = document.getElementById('chatForm');
        const chatMessages = document.getElementById('chatMessages');
        const initialPlaceholder = document.querySelector('.initial-placeholder');
        const sendButton = document.getElementById('sendButton');
        
        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessageText = ""; 

            const classGrade = document.getElementById('classGrade').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const lessonName = document.getElementById('lessonName').value.trim();
            

            if (!classGrade || !subject || !lessonName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³.');
                return;
            }

            if (initialPlaceholder) {
                initialPlaceholder.style.display = 'none';
            }

            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';

            const loadingMessageElement = appendMessage('', 'ai-message', true);
            loadingMessageElement.innerHTML = '<div class="ai-message-content" style="text-align: center;"><p>Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø³...</p><div class="loading-dots"><span></span><span></span><span></span></div></div>';

            try {
                const aiResponseText = await tryApiKeys(userMessageText, classGrade, subject, lessonName, AI_INSTRUCTIONS);
                loadingMessageElement.innerHTML = ''; 
                renderAIResponseAsHTML(aiResponseText, loadingMessageElement);
            } catch (error) {
                console.error('Error fetching AI response:', error);
                loadingMessageElement.innerHTML = '';
                renderAIResponseAsHTML(`Ø®Ø·Ø£: ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ø¯Ø±Ø³. ${error.message}`, loadingMessageElement, true);
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„';
            }
        });

        async function tryApiKeys(userPrompt, grade, subject, topic, instructions) {
            let lastError = null;
            for (const apiKey of API_KEYS) {
                try {
                    const response = await getAIResponse(userPrompt, grade, subject, topic, instructions, apiKey);
                    return response; // Success
                } catch (error) {
                    console.warn(`API key starting with ${apiKey.substring(0, 8)}... failed.`, error);
                    lastError = error;
                }
            }
            // If all keys failed, throw the last error
            throw new Error(`All API keys failed. Last error: ${lastError.message}`);
        }

        function appendMessage(textOrHtml, className, isHTML = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', className);
            if (isHTML) {
                messageElement.innerHTML = textOrHtml;
            } else {
                messageElement.textContent = textOrHtml;
            }
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }

        async function getAIResponse(userPrompt, grade, subject, topic, instructions, apiKey) {
            const AI_API_ENDPOINT_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash';
            const AI_API_ENDPOINT = `${AI_API_ENDPOINT_BASE}:generateContent`;



            const fullPrompt = `
${instructions}

CONTEXT FOR LESSON PLAN (provided by user via form fields):
Class Grade: ${grade}
Subject: ${subject}
Lesson Topic/Title: ${topic}

USER'S SPECIFIC REQUEST FOR THE LESSON PLAN (from chat input, if any):
${userPrompt} 

Generate the lesson plan in Arabic now based on all the above information and the detailed example provided in the instructions.
Ensure the output is ONLY the lesson plan content, in Markdown, ready for rendering.
`;
            
            const geminiRequestBody = {
              "contents": [{"parts": [{"text": fullPrompt}]}],
              "generationConfig": {
                "temperature": 0.6,
                "maxOutputTokens": 4096, 
                "candidateCount": 1
              },
            };

            console.log("Sending to Gemini AI. Review request body structure if issues arise.");

            const response = await fetch(`${AI_API_ENDPOINT}?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(geminiRequestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                console.error("API Error Data:", errorData);
                let errorMessage = `ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©: ${response.status}`;
                if (errorData && errorData.error && errorData.error.message) {
                    errorMessage += ` - ${errorData.error.message}`;
                } else if (errorData && errorData.message) { 
                    errorMessage += ` - ${errorData.message}`;
                } else {
                    errorMessage += ` - ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();

            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) {
                 return data.candidates[0].content.parts[0].text.trim();
            } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                 console.error("Prompt blocked by API:", data.promptFeedback);
                 let blockDetail = "";
                 if(data.promptFeedback.safetyRatings && data.promptFeedback.safetyRatings.length > 0){
                    blockDetail = data.promptFeedback.safetyRatings.map(r => `${r.category}: ${r.probability}`).join(', ');
                 }
                 throw new Error(`ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø·Ù„Ø¨ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø¨Ø³Ø¨Ø¨ "${data.promptFeedback.blockReason}". ${blockDetail ? 'Ø§Ù„ØªÙØ§ØµÙŠÙ„: ' + blockDetail : ''}`);
            }
            else {
                console.warn("AI response format not recognized or empty, dumping data:", data);
                 if (data.error && data.error.message) { 
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©: ${data.error.message}`);
                }
                throw new Error("ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ùˆ ÙØ§Ø±Øº. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
            }
        }
        
        function renderAIResponseAsHTML(markdownText, messageElement, isError = false) {
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('ai-message-content');
            contentDiv.setAttribute('dir', 'rtl'); 

            if (isError) {
                const p = document.createElement('p');
                p.style.color = 'red';
                p.textContent = markdownText;
                contentDiv.appendChild(p);
                messageElement.appendChild(contentDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return;
            }

            let htmlContent = '';
            let inList = null; 
            let inTable = false;
            let tableHeaderParsed = false; 

            const lines = markdownText.split('\n');

            lines.forEach(line => {
                const trimmedLine = line.trim();

                if (trimmedLine.startsWith('|') && trimmedLine.endsWith('|')) {
                    if (!inTable) {
                        htmlContent += '<table>';
                        inTable = true;
                        tableHeaderParsed = false; 
                    }
                    const cells = trimmedLine.slice(1, -1).split('|').map(cell => cell.trim());
                    
                    if (!tableHeaderParsed && cells.every(cell => cell.replace(/-/g, '').trim() === '')) {
                        tableHeaderParsed = true; 
                        return; 
                    }

                    htmlContent += '<tr>';
                    cells.forEach((cell) => {
                        const cellContent = applyInlineFormatting(cell); 
                        if (!tableHeaderParsed) { 
                            htmlContent += `<th>${cellContent}</th>`;
                        } else { 
                            htmlContent += `<td>${cellContent}</td>`;
                        }
                    });
                    htmlContent += '</tr>';
                    
                    if (!tableHeaderParsed && !cells.every(cell => cell.replace(/-/g, '').trim() === '')) {
                        // If this first row was not a separator, assume it was the header.
                        // For subsequent rows to be <td>, tableHeaderParsed needs to be true.
                        // However, the logic relies on *explicitly* finding the separator.
                        // If no separator is found, all rows might become <th> if this isn't set.
                        // This is a bit tricky; best practice is for AI to provide the separator.
                        // For now, if AI doesn't provide separator, first row is <th>, subsequent are also <th>
                        // unless we uncomment: tableHeaderParsed = true; 
                        // But this means a single-row table without separator will have its single row as header.
                        // The prompt strongly asks AI to follow example with separator.
                    }
                    return; 
                } else if (inTable) { 
                    htmlContent += '</table>';
                    inTable = false;
                    tableHeaderParsed = false; 
                }

                if (trimmedLine.startsWith('###### ')) { htmlContent += `<h6>${applyInlineFormatting(trimmedLine.substring(7))}</h6>`; }
                else if (trimmedLine.startsWith('##### ')) { htmlContent += `<h5>${applyInlineFormatting(trimmedLine.substring(6))}</h5>`; }
                else if (trimmedLine.startsWith('#### ')) { htmlContent += `<h4>${applyInlineFormatting(trimmedLine.substring(5))}</h4>`; }
                else if (trimmedLine.startsWith('### ')) { htmlContent += `<h3>${applyInlineFormatting(trimmedLine.substring(4))}</h3>`; }
                else if (trimmedLine.startsWith('## ')) { htmlContent += `<h2>${applyInlineFormatting(trimmedLine.substring(3))}</h2>`; }
                else if (trimmedLine.startsWith('# ')) { htmlContent += `<h1>${applyInlineFormatting(trimmedLine.substring(2))}</h1>`; }
                else if (trimmedLine === '---' || trimmedLine === '***' || trimmedLine === '___') {
                    if (!inTable) htmlContent += '<hr>'; 
                }
                else if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                    if (inList !== 'ul') {
                        if (inList) htmlContent += `</${inList}>`;
                        htmlContent += '<ul>';
                        inList = 'ul';
                    }
                    htmlContent += `<li>${applyInlineFormatting(trimmedLine.substring(2))}</li>`;
                }
                else if (trimmedLine.match(/^\d+\.\s/)) {
                    if (inList !== 'ol') {
                        if (inList) htmlContent += `</${inList}>`;
                        htmlContent += '<ol>';
                        inList = 'ol';
                    }
                    htmlContent += `<li>${applyInlineFormatting(trimmedLine.replace(/^\d+\.\s/, ''))}</li>`;
                }
                else {
                    if (inList) {
                        htmlContent += `</${inList}>`;
                        inList = null;
                    }
                    if (trimmedLine !== '') {
                        htmlContent += `<p>${applyInlineFormatting(trimmedLine)}</p>`;
                    }
                }
            });

            if (inList) htmlContent += `</${inList}>`;
            if (inTable) htmlContent += '</table>'; 

            contentDiv.innerHTML = htmlContent;
            messageElement.appendChild(contentDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function applyInlineFormatting(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            text = text.replace(/(?<!\*)\*(?!\s|\*)(.*?)(?<!\s|\*)\*(?!\*)/g, '<em>$1</em>'); 
            text = text.replace(/(?<!_)\_(?!\s|_)(.*?)(?<!\s|_)\_(?!_)/g, '<em>$1</em>');     
            text = text.replace(/~~(.*?)~~/g, '<del>$1</del>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            return text;
        }
    </script>

</body>
</html>
